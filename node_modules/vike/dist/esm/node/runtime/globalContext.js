// Public use
export { getGlobalContextSync };
export { getGlobalContextAsync };
// Internal use
export { initGlobalContext };
export { getGlobalContext };
export { getViteDevServer };
export { getViteConfig };
export { setGlobalContext_viteDevServer };
export { setGlobalContext_prerender };
export { getRuntimeManifest };
import { assert, assertNodeEnv_runtime, assertUsage, assertWarning, getGlobalObject, isPlainObject, objectAssign, objectKeys } from './utils.js';
import { loadImportBuild } from './globalContext/loadImportBuild.js';
import { setPageFiles } from '../../shared/getPageFiles.js';
import { assertPluginManifest } from '../shared/assertPluginManifest.js';
import { getConfigVike } from '../shared/getConfigVike.js';
import { assertRuntimeManifest } from '../shared/assertRuntimeManifest.js';
import pc from '@brillout/picocolors';
let resolveGlobalContext;
const globalObject = getGlobalObject('globalContext.ts', {
    globalContextPromise: new Promise((r) => (resolveGlobalContext = r))
});
function getGlobalContext() {
    assert(globalObject.globalContext);
    return globalObject.globalContext;
}
/** @experimental https://vike.dev/getGlobalContext */
function getGlobalContextSync() {
    assertUsage(globalObject.globalContext, "The global context isn't set yet, call getGlobalContextSync() later or use getGlobalContextAsync() instead.");
    return makePublic(globalObject.globalContext);
}
/** @experimental https://vike.dev/getGlobalContext */
async function getGlobalContextAsync() {
    await globalObject.globalContextPromise;
    assert(globalObject.globalContext);
    return makePublic(globalObject.globalContext);
}
function makePublic(globalContext) {
    const globalContextPublic = {
        assetsManifest: globalContext.assetsManifest
    };
    // Add internals (and prepended _ prefix to their keys)
    {
        const publicKeys = Object.keys(globalContextPublic);
        objectKeys(globalContext)
            .filter((key) => !publicKeys.includes(key))
            .forEach((key) => {
            const keyPublic = `_${key}`;
            Object.defineProperty(globalContextPublic, keyPublic, {
                enumerable: true,
                get() {
                    assertWarning(false, `Using internal globalContext.${keyPublic} which is discouraged: it may break in any minor version update. Instead, reach out on GitHub and elaborate your use case.`, {
                        onlyOnce: true
                    });
                    return globalContext[key];
                }
            });
        });
    }
    return globalContextPublic;
}
function setGlobalContext_viteDevServer(viteDevServer) {
    if (globalObject.viteDevServer)
        return;
    assert(!globalObject.globalContext);
    assert(!globalObject.globalContext);
    globalObject.viteConfig = viteDevServer.config;
    globalObject.viteDevServer = viteDevServer;
}
function getViteDevServer() {
    return globalObject.viteDevServer ?? null;
}
function setGlobalContext_prerender(viteConfig) {
    if (globalObject.viteConfig)
        return;
    assert(!globalObject.globalContext);
    globalObject.viteConfig = viteConfig;
}
function getViteConfig() {
    return globalObject.viteConfig ?? null;
}
async function initGlobalContext(isPrerendering = false, outDir) {
    if (globalObject.globalContext)
        return;
    const { viteDevServer, viteConfig } = globalObject;
    assertNodeEnv_runtime(!!viteDevServer);
    const isProduction = !viteDevServer;
    if (!isProduction) {
        assert(viteConfig);
        assert(!isPrerendering);
        const configVike = await getConfigVike(viteConfig);
        const pluginManifest = getRuntimeManifest(configVike);
        globalObject.globalContext = {
            isProduction: false,
            isPrerendering: false,
            assetsManifest: null,
            pluginManifest: null,
            viteDevServer,
            viteConfig,
            baseServer: pluginManifest.baseServer,
            baseAssets: pluginManifest.baseAssets,
            includeAssetsImportedByServer: pluginManifest.includeAssetsImportedByServer,
            redirects: pluginManifest.redirects,
            trailingSlash: pluginManifest.trailingSlash,
            disableUrlNormalization: pluginManifest.disableUrlNormalization
        };
    }
    else {
        const buildEntries = await loadImportBuild(outDir);
        assertBuildEntries(buildEntries, isPrerendering ?? false);
        const { pageFiles, assetsManifest, pluginManifest } = buildEntries;
        setPageFiles(pageFiles);
        assertViteManifest(assetsManifest);
        assertPluginManifest(pluginManifest);
        const globalContext = {
            isProduction: true,
            assetsManifest,
            pluginManifest,
            viteDevServer: null,
            baseServer: pluginManifest.baseServer,
            baseAssets: pluginManifest.baseAssets,
            includeAssetsImportedByServer: pluginManifest.includeAssetsImportedByServer,
            redirects: pluginManifest.redirects,
            trailingSlash: pluginManifest.trailingSlash,
            disableUrlNormalization: pluginManifest.disableUrlNormalization
        };
        if (isPrerendering) {
            assert(viteConfig);
            const configVike = await getConfigVike(viteConfig);
            assert(configVike);
            objectAssign(globalContext, {
                isPrerendering: true,
                viteConfig
            });
            globalObject.globalContext = globalContext;
        }
        else {
            objectAssign(globalContext, {
                isPrerendering: false,
                viteConfig: null
            });
            globalObject.globalContext = globalContext;
        }
    }
    resolveGlobalContext(globalObject.globalContext);
}
function getRuntimeManifest(configVike) {
    const { includeAssetsImportedByServer, baseServer, baseAssets, redirects, trailingSlash, disableUrlNormalization } = configVike;
    const manifest = {
        baseServer,
        baseAssets,
        includeAssetsImportedByServer,
        redirects,
        trailingSlash,
        disableUrlNormalization
    };
    assertRuntimeManifest(manifest);
    return manifest;
}
function assertBuildEntries(buildEntries, isPreRendering) {
    const errMsg = [
        `You are tyring to run`,
        isPreRendering ? 'pre-rendering' : 'the server for production',
        `but your app isn't built yet. Run ${pc.cyan('$ vite build')} before `,
        isPreRendering ? 'pre-rendering.' : 'running the server.'
    ].join(' ');
    assertUsage(buildEntries, errMsg);
}
function assertViteManifest(manifest) {
    assert(isPlainObject(manifest));
    /* We should include these assertions but we don't as a workaround for PWA manifests: https://github.com/vikejs/vike/issues/769
       Instead, we should rename the vite manifest e.g. with https://vitejs.dev/config/build-options.html#build-manifest
    Object.entries(manifest)
      // circumvent esbuild bug: esbuild adds a `default` key to JSON upon `require('./some.json')`.
      .filter(([key]) => key !== 'default')
      .forEach(([_, entry]) => {
        assert(isPlainObject(entry))
        assert(typeof entry.file === 'string')
      })
    */
}
